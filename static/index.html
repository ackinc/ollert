<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Trello Clone</title>

    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/global.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script src="https://apis.google.com/js/api:client.js"></script>
</head>

<body>
    <header>
        <h1>
            <a href="">A Trello Clone</a>
        </h1>
        <h2>(in vanilla Javascript)</h2>
    </header>

    <main>
        <section id="register_form" style="display: none">
            <h1>Register</h1>
            <div class="split">
                <form name="register" class="left">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" name="username" autofocus required />
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required />
                    </div>

                    <div class="input-group">
                        <label>Confirm password</label>
                        <input type="password" name="c_password" required />
                    </div>

                    <div class="info"></div>
                    <div class="error"></div>

                    <button type="submit">Sign me up!</button>
                </form>

                <div class="separator"></div>

                <div class="social-login right">
                    <h1>Sign up with</h1>
                    <div class="btn-google">
                        <img src="./images/btn_google_light_normal_ios.png" /> Google
                    </div>
                </div>
            </div>

            <p>Already registered? Sign in
                <span class="toggle-form" data-show="login_form">here</span>
            </p>
        </section>

        <section id="login_form">
            <h1>Login</h1>
            <div class="split">
                <form name="login" class="left">

                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" name="username" required />
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required />
                    </div>

                    <div class="info"></div>
                    <div class="error"></div>

                    <button type="submit">Sign me in!</button>
                </form>

                <div class="separator"></div>

                <div class="social-login right">
                    <h1>Sign in with</h1>
                    <div class="btn-google">
                        <img src="./images/btn_google_light_normal_ios.png" /> Google
                    </div>
                </div>

            </div>

            <p>New user? Sign up
                <span class="toggle-form" data-show="register_form">here</span>
            </p>
        </section>
    </main>

    <script>
        const main_node = document.querySelector('main');
        const reg_section = document.querySelector('section#register_form');
        const login_section = document.querySelector('section#login_form');

        const REGISTRATION_API_URL = '/api/register';
        const LOGIN_API_URL = '/api/login';

        let cur_section = login_section;

        document.querySelectorAll('span.toggle-form').forEach(elem => {
            elem.addEventListener('click', toggleForms);
        });

        reg_section.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();

            this.querySelector('.info').innerHTML = ``;
            this.querySelector('.error').innerHTML = ``;

            const username = this.querySelector('input[name="username"]').value;
            const pass = this.querySelector('input[name="password"]').value;
            const c_pass = this.querySelector('input[name="c_password"]').value;
            if (pass !== c_pass) {
                this.querySelector('.error').innerHTML = `Passwords don't match`;
                return;
            }

            fetch(REGISTRATION_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: pass })
            })
                .then(res => res.json())
                .then(body => {
                    if (body.error) {
                        this.querySelector('.error').innerHTML = body.error;
                    } else if (body.redirect_url) {
                        document.location.replace(body.redirect_url);
                    } else {
                        this.querySelector('.info').innerHTML = `Registration successful. Please log in.`;
                    }
                })
                .catch(err => {
                    this.querySelector('.error').innerHTML = `Network error.`;
                });
        });

        login_section.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();

            this.querySelector('.info').innerHTML = ``;
            this.querySelector('.error').innerHTML = ``;

            const username = this.querySelector('input[name="username"]').value;
            const pass = this.querySelector('input[name="password"]').value;

            fetch(LOGIN_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: pass })
            })
                .then(res => res.json())
                .then(body => {
                    if (body.error) {
                        this.querySelector('.error').innerHTML = body.error;
                    } else if (body.redirect_url) {
                        document.location.replace(body.redirect_url);
                    } else {
                        document.location.replace('./boards.html');
                    }
                })
                .catch(err => {
                    this.querySelector('.error').innerHTML = `Network error.`;
                });
        });

        function toggleForms() {
            const other_section = cur_section === reg_section ? login_section : reg_section;
            other_section.style.display = cur_section.style.display;
            cur_section.style.display = "none";
            cur_section = other_section;
            cur_section.querySelector('input').focus();
        }
    </script>

    <script>
        gapi.load('auth2', function () {
            // Retrieve the singleton for the GoogleAuth library and set up the client.
            auth2 = gapi.auth2.init({
                client_id: '396738301585-h6sjke032j2nlvn6gc2d41so8d2ins53.apps.googleusercontent.com',
                cookiepolicy: 'single_host_origin',
                // Request scopes in addition to 'profile' and 'email'
                // scope: 'additional_scope'
            });
            document.querySelectorAll('.btn-google').forEach(elem => {
                auth2.attachClickHandler(elem, {}, googleUser => {
                    const token = googleUser.getAuthResponse().id_token;
                    fetch(LOGIN_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider: 'google', token: token })
                    })
                        .then(res => res.json())
                        .then(body => {
                            if (body.error) {
                                cur_section.querySelector('.error').innerHTML = body.error;
                            } else if (body.redirect_url) {
                                document.location.replace(body.redirect_url);
                            } else {
                                document.location.replace('./boards.html');
                            }
                        })
                        .catch(err => {
                            cur_section.querySelector('.error').innerHTML = `Network error.`;
                        });
                });
            });
        });
    </script>
</body>

</html>
