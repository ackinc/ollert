<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Trello Clone</title>

    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/global.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
</head>

<body>
    <header>
        <h1>
            <a href="">A Trello Clone</a>
        </h1>
        <h2>(in vanilla Javascript)</h2>
    </header>

    <main>
        <section id="registration_section" class="user-action-section">
            <h1>Register</h1>
            <div class="split">
                <form name="registration_form" class="left">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="username" autofocus required />
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required />
                    </div>

                    <div class="input-group">
                        <label>Confirm password</label>
                        <input type="password" name="c_password" required />
                    </div>

                    <div class="info"></div>
                    <div class="error"></div>

                    <button type="submit">Sign me up!</button>
                </form>

                <div class="separator"></div>

                <div class="social-login right">
                    <h1>Sign up with</h1>
                    <div class="btn-social-login btn-google">
                        <img src="./images/google_logo.png" /> Google
                    </div>
                    <div class="btn-social-login btn-facebook">
                        <img src="./images/fb_logo_color.png" /> Facebook
                    </div>
                </div>
            </div>

            <p>Already registered? Sign in
                <span class="change-active-section" data-show="login_section">here</span>
            </p>
        </section>

        <section id="login_section" class="user-action-section">
            <h1>Login</h1>
            <div class="split">
                <form name="login_form" class="left">

                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="username" required />
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required />
                    </div>

                    <div class="info"></div>
                    <div class="error"></div>

                    <button type="submit">Sign me in!</button>
                </form>

                <div class="separator"></div>

                <div class="social-login right">
                    <h1>Sign in with</h1>
                    <div class="btn-social-login btn-google">
                        <img src="./images/google_logo.png" /> Google
                    </div>
                    <div class="btn-social-login btn-facebook">
                        <img src="./images/fb_logo_color.png" /> Facebook
                    </div>
                </div>

            </div>

            <p>New user? Sign up
                <span class="change-active-section" data-show="registration_section">here</span>
            </p>
        </section>
    </main>

    <script>
        const REGISTRATION_API_URL = '/api/register';
        const LOGIN_API_URL = '/api/login';

        const main_node = document.querySelector('main');
        const all_sections = document.querySelectorAll('.user-action-section');
        let cur_section;
        showSection('login_section');

        // displays the section having id <id>,while hiding other sections
        function showSection(id) {
            all_sections.forEach(section => {
                if (section.id === id) {
                    section.classList.remove('hide');
                    section.querySelector('input').focus();
                    cur_section = section;
                } else {
                    section.classList.add('hide');
                }
            });
        }

        document.querySelectorAll('span.change-active-section').forEach(elem => {
            elem.addEventListener('click', function (e) {
                showSection(this.dataset.show);
            });
        });

        document.querySelector('form[name="registration_form"]').addEventListener('submit', function (e) {
            e.preventDefault();

            this.querySelector('.info').innerHTML = ``;
            this.querySelector('.error').innerHTML = ``;

            const username = this.querySelector('input[name="username"]').value;
            const pass = this.querySelector('input[name="password"]').value;
            const c_pass = this.querySelector('input[name="c_password"]').value;
            if (pass !== c_pass) {
                this.querySelector('.error').innerHTML = `Passwords don't match`;
                return;
            }

            fetch(REGISTRATION_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: pass })
            })
                .then(res => res.json())
                .then(body => {
                    if (body.error) {
                        this.querySelector('.error').innerHTML = body.error;
                    } else {
                        this.querySelector('.info').innerHTML = body.message;
                    }
                })
                .catch(err => {
                    this.querySelector('.error').innerHTML = `Network error.`;
                });
        });

        document.querySelector('form[name="login_form"]').addEventListener('submit', function (e) {
            e.preventDefault();

            this.querySelector('.info').innerHTML = ``;
            this.querySelector('.error').innerHTML = ``;

            const username = this.querySelector('input[name="username"]').value;
            const pass = this.querySelector('input[name="password"]').value;

            tryLogin({ username: username, password: pass });
        });

        function tryLogin(credentials) {
            fetch(LOGIN_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            })
                .then(res => res.json())
                .then(handleLoginResponse)
                .catch(err => {
                    cur_section.querySelector('.error').innerHTML = `Network error.`;
                });
        }

        function handleLoginResponse(body) {
            if (body.error) {
                cur_section.querySelector('.error').innerHTML = body.error;
            } else if (body.message === 'VERIFICATION_EMAIL_SENT') {
                cur_section.querySelector('.info').innerHTML = body.message;
            } else {
                document.location.replace('./boards.html');
            }
        }
    </script>



    <script src="https://apis.google.com/js/api:client.js"></script>
    <script>
        gapi.load('auth2', function () {
            // Retrieve the singleton for the GoogleAuth library and set up the client.
            auth2 = gapi.auth2.init({
                client_id: '396738301585-h6sjke032j2nlvn6gc2d41so8d2ins53.apps.googleusercontent.com',
                cookiepolicy: 'single_host_origin',
                // Request scopes in addition to 'profile' and 'email'
                // scope: 'additional_scope'
            });
            document.querySelectorAll('.btn-google').forEach(elem => {
                auth2.attachClickHandler(elem, {}, googleUser => {
                    const token = googleUser.getAuthResponse().id_token;
                    tryLogin({ provider: 'google', token: token });
                });
            });
        });
    </script>


    <script src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '1787740664771115',
                cookie: true,  // enable cookies to allow the server to access the session
                xfbml: true,  // parse social plugins on this page
                version: 'v3.0' // use graph api version 3.0
            });

            document.querySelectorAll('.btn-facebook').forEach(elem => {
                elem.addEventListener('click', function (e) {
                    FB.login(response => {
                        if (response.status !== 'connected') {
                            cur_section.querySelector('.error').innerHTML = `Authentication error.`;
                            return;
                        };

                        const token = response.authResponse.accessToken;
                        tryLogin({ provider: 'facebook', token: token });
                    }, { scope: 'email' });
                });
            });
        }
    </script>
</body>

</html>
